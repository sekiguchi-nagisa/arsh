#$test($envs = ['ASAN_OPTIONS' : 'detect_leaks=0:verbosity=1:log_threads=1'])
## disable leak sanitizer for workaround

# global
var a = 0
$a += 1
assert($a == 1)
$a *= 2
assert($a == 2)
$a /= 2
assert($a == 1)
$a %= 1
assert($a == 0)
$a -= 1
assert($a == -1)

var s = 'he'
$s += 'llo'
assert $s == "hello"

$s = '0123456789abcdefghijk'
$s += ''
$s += 'l'
$s += '##' + $s
assert $s == '0123456789abcdefghijkl##0123456789abcdefghijkl'

var icount = 0;
function getstr() : String {
    $icount++;
    return "check empty and assign"
}
$s := $getstr()
assert $icount == 0
assert $s == '0123456789abcdefghijkl##0123456789abcdefghijkl'
$s = ''
$s := $getstr()
assert $icount == 1
assert $s == 'check empty and assign'

var b = '23'.toInt()
$b ??= 0
assert $b! == 23
$b = 'hoge'.toInt()
$b ??= 100
assert $b! == 100


# local
{
    var a = 0
    $a += 1
    assert($a == 1)
    $a *= 2
    assert($a == 2)
    $a /= 2
    assert($a == 1)
    $a %= 1
    assert($a == 0)
    $a -= 1
    assert($a == -1)

    var s = ''
    $s += "ab"
    assert($s == 'ab')
    $s = ''
    assert $s.empty()

    $s := $getstr()
    assert $s == 'check empty and assign'
    assert $icount == 2

    var b1 = '23.3'.toFloat()
    $b1 ??= 3.14
    assert $b1! == 23.3
    $b1 = 'hoge'.toFloat()
    $b1 ??= 3.14
    assert $b1! == 3.14
}

# field
var t = (0, 12)
$t._0 += 1
assert($t._0 == 1)
$t._0 *= 2
assert($t._0 == 2)
$t._0 /= 2
assert($t._0 == 1)
$t._0 %= 1
assert($t._0 == 0)
$t._0 -= 1
assert($t._0 == -1)

$t._1 -= 10
assert($t._1 == 2)

var t2 = ("", 23)
$t2._0 += "abcd"
assert $t2._0 == "abcd"
$t2._0 = ''
assert $t2._0.empty()

$t2._0 := $getstr()
assert $t2._0 == 'check empty and assign'
assert $icount == 3

var t3 = ('~hfore'.realpath(),)
$t3._0 ??= "/"
assert $t3._0! == "/"
$t3._0 = '~'.realpath()
$t3._0 ??= 'hoge'
assert $t3._0! == "$(echo ~)"


# indexer
var i = [0]
$i[0] += 1
assert($i[0] == 1)
$i[0] *= 2
assert($i[0] == 2)
$i[0] /= 2
assert($i[0] == 1)
$i[0] %= 1
assert($i[0] == 0)
$i[0] -= 1
assert($i[0] == -1)

var w = ["a" : 1]
$w["a"] += 23
assert($w["a"] == 24)

var i2 = [0 : "12"]
$i2[0] += "34"
assert $i2[0] == "1234"
$i2[0] += -5 + $i2[0]
assert $i2[0] == "1234-51234"

$i2[0] := $getstr()
assert $i2[0] == "1234-51234"
assert $icount == 3

$i2[0] = ''
$i2[0] := $getstr()
assert $i2[0] == "check empty and assign"
assert $icount == 4

var i3 = [new Int!()]
$i3[0] ??= 12
assert $i3[0]! == 12
$i3[0] ??= 100
assert $i3[0]! == 12

# env
export-env ABCD = ""
$ABCD := $getstr()
assert $ABCD == 'check empty and assign'
assert $icount == 5

var ex = 34 as Any
try {
    $ABCD = $'hello\x00'
} catch $e {
    $ex = $e
}
assert $ex is IllegalAccessError

true