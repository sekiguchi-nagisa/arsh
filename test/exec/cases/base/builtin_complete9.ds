
# complete options defined by CLI attribute

[<CLI>]
typedef CCC() {
    [<Arg>]
    var target = ""
}

var OPT: String?

function count(opt: String, prefixToken: String): Candidates? {
    let prefix = $prefixToken.dequote()
    $OPT = $opt
    var ret: Candidates
    for c in ['111', '123', '1234', '222'] {
        if $c.startsWith($prefix) {
            $ret.add($c)
        }
    }
    $prefix.startsWith('EEE') && throw new InvalidOperationError($prefix)
    $ret.quote($prefixToken)
    return $ret
}

function output(opt: String, prefixToken: String): Candidates? {
    let prefix = $prefixToken.dequote()
    var ret: Candidates
    for c in ['AAA', 'AAB', 'ABB', 'ABC'] {
        if $c.startsWith($prefix) {
            $ret.add($c)
        }
    }
    $ret.quote($prefixToken)
    return $ret
}

[<CLI>]
typedef BBB() {
    [<Flag(short: "v")>]
    var verbose = $false

    [<Option(short: "c", long: "count", comp: $count)>]
    var count = 0

    [<Option(short: 'o', long: "output", opt:$true, comp: $output, help:$'set output file\n12')>]
    var output : String?

    [<Option(choice: ['debug', 'info', 'warn', 'error'], help:"")>]
    var log = "warn"

    [<Option(choice: ['stdin', 'stdout', 'stderr'], opt:$true, short:'s', long:'stream', help:"set input stream (default is stdin)")>]
    var stream = "stdin"

    [<SubCmd>]
    var ccc : CCC?
}

[<CLI>]
typedef AAA() {
    [<Option(opt: $true, short: 'd', long: 'dump')>]
    var dump : String?

    [<Flag(short: 'v', long: 'version')>]
    var version : Bool?

    [<Option(help: "")>]
    var count : Int?

    [<SubCmd(name: "bbb1")>]
    [<SubCmd(name: "bbb2")>]
    var bbb : BBB?
}

fff(p : AAA) { echo $p; }
ggg() { echo $@; }

## complete options
complete -s -- 'fff -'
assert $COMPREPLY.size() == 7
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)
assert $COMPREPLY[1] == "--dump"
assert $COMPREPLY.hasSpace(1)
assert $COMPREPLY[2] == "--help"
assert $COMPREPLY.hasSpace(2)
assert $COMPREPLY[3] == "--version"
assert $COMPREPLY.hasSpace(3)
assert $COMPREPLY[4] == "-d"
assert $COMPREPLY.hasSpace(4)
assert $COMPREPLY[5] == "-h"
assert $COMPREPLY.hasSpace(5)
assert $COMPREPLY[6] == "-v"
assert $COMPREPLY.hasSpace(6)

complete -s -- 'fff --'
assert $COMPREPLY.size() == 4
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)
assert $COMPREPLY[1] == "--dump"
assert $COMPREPLY.hasSpace(1)
assert $COMPREPLY[2] == "--help"
assert $COMPREPLY.hasSpace(2)
assert $COMPREPLY[3] == "--version"
assert $COMPREPLY.hasSpace(3)

complete -s -- 'fff -\-c'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "-\\-count="
assert ! $COMPREPLY.hasSpace(0)

complete -s -- 'fff --count'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)

complete -s -- 'fff --\d\'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--\\d\\ump"
assert $COMPREPLY.hasSpace(0)

complete -s -- 'fff --dump'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--dump"
assert $COMPREPLY.hasSpace(0)

complete -s -- 'fff bbb1 -'
assert $COMPREPLY.size() == 10
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)
assert $COMPREPLY[1] == "--help"
assert $COMPREPLY.hasSpace(1)
assert $COMPREPLY[2] == "--log="
assert ! $COMPREPLY.hasSpace(2)
assert $COMPREPLY[3] == "--output"
assert $COMPREPLY.hasSpace(3)
assert $COMPREPLY[4] == "--stream"
assert $COMPREPLY.hasSpace(4)
assert $COMPREPLY[5] == "-c"
assert $COMPREPLY.hasSpace(5)
assert $COMPREPLY[6] == "-h"
assert $COMPREPLY.hasSpace(6)
assert $COMPREPLY[7] == "-o"
assert $COMPREPLY.hasSpace(7)
assert $COMPREPLY[8] == "-s"
assert $COMPREPLY.hasSpace(8)
assert $COMPREPLY[9] == "-v"
assert $COMPREPLY.hasSpace(9)

complete -s -d -- 'fff bbb2 --'
assert @($COMPREPLY) == @(
    "--count="
    "--help@show this help message"
    "--log="
    $'--output@set output file\n12'
    "--stream@set input stream (default is stdin)"
)

## complete file names after options (fallback)
assert diff <(complete -- 'fff --count ') <(complete -A file)
assert diff <(complete -- 'fff --version ') <(complete -A file)
assert diff <(complete -- 'fff --version ./') <(complete -A file './')
assert diff <(complete -- 'fff --count=') <(complete -A file)
assert diff <(complete -- 'fff --dump=') <(complete -A file)
assert diff <(complete -- 'fff --fajjaiae ') <(complete -A file)  # complete file names after invalid option

## complete via user-defined func
assert diff <(complete -- 'fff bbb1 -v --c\ount ') <(printf "%s\n" 111 123 1234 222 )
assert diff <(complete -- 'fff bbb1 -v --c\ount \') <(printf "%s\n" '\111' '\123' '\1234' '\222' )
assert diff <(complete -- 'fff bbb1 -\-count=') <(printf "%s\n" 111 123 1234 222 )
assert diff <(complete -- 'fff bbb1 -\-count=\') <(printf "%s\n" '\111' '\123' '\1234' '\222' )
assert diff <(complete -- 'fff bbb1 -c 12') <(printf "%s\n" 123 1234 )
assert diff <(complete -- 'fff bbb1 --count 12') <(printf "%s\n" 123 1234 )
assert diff <(complete -- 'fff bbb1 --count \1\2\') <(printf "%s\n" '\1\2\3' '\1\2\34' )
assert diff <(complete -- 'fff bbb1 --count=2') <(printf "%s\n" 222)
assert diff <(complete -- 'fff bbb1 --count=2\') <(printf "%s\n" '2\22')
assert $(complete -- 'fff bbb1 --count=3').empty()
assert diff <(complete -- 'fff bbb1 --output=') <(printf "%s\n" 'AAA' 'AAB' 'ABB' 'ABC' )
assert diff <(complete -- 'fff bbb1 --output ') <(complete -A file)
assert diff <(complete -- 'fff bbb1 -o') <(printf "%s\n" 'AAA' 'AAB' 'ABB' 'ABC' )
assert diff <(complete -- 'fff bbb1 -o\') <(printf "%s\n" '\AAA' '\AAB' '\ABB' '\ABC' )
assert diff <(complete -- 'fff bbb1 -oA') <(printf "%s\n" 'AAA' 'AAB' 'ABB' 'ABC' )
assert diff <(complete -- 'fff bbb1 -o\A') <(printf "%s\n" '\AAA' '\AAB' '\ABB' '\ABC' )
assert diff <(complete -- 'fff bbb1 -oA\B\') <(printf "%s\n"  'A\B\B' 'A\B\C' )
assert diff <(complete -- 'fff bbb1 -o ') <(complete -A file) # fallback

$OPT = $none
complete -- 'fff bbb1 --count '
assert $OPT! == '--count'

$OPT = $none
complete -- 'fff bbb1 --count=12'
assert $OPT! == '--count='

var ex = 2345 as Any
try { complete -- 'fff bbb1 --count=EEER'; } catch e { $ex = $e; }
assert ($ex as InvalidOperationError).message() == 'EEER'

## complete choice
assert diff <(complete -- 'fff bbb1 --log=') <(printf "%s\n" debug error info warn)
assert diff <(complete -- 'fff bbb1 \--l\og=') <(printf "%s\n" debug error info warn)
assert diff <(complete -- 'fff bbb1 --log i') <(printf "%s\n" info)
assert diff <(complete -- 'fff bbb1 -ss') <(printf "%s\n" stderr stdin stdout)
assert diff <(complete -- 'fff bbb1 -\ss\t') <(printf "%s\n" 's\tderr' 's\tdin' 's\tdout')
assert diff <(complete -- 'fff bbb1 -s ') <(complete -A file) # fallback
assert diff <(complete -- 'fff bbb1 "--log" info --stream=') <(printf "%s\n" stderr stdin stdout)
assert diff <(complete -- 'fff bbb1 "--log" info --stream=\') <(printf "%s\n" '\stderr' '\stdin' '\stdout')
assert diff <(complete -- 'fff bbb1 "--log" info --stream=stde') <(printf "%s\n" stderr)
assert diff <(complete -- 'fff bbb1 --log=info --stream=stde') <(printf "%s\n" stderr)
assert diff <(complete -- 'fff bbb1 --stream ') <(complete -A file) # fallback

## complete sub-command
assert diff <(complete -- 'fff ') <(echo 'bbb1' && echo bbb2)
assert diff <(complete -- 'fff b')  <(echo 'bbb1' && echo bbb2)
assert diff <(complete -- 'fff bbb1 ')  <(echo 'ccc')
assert diff <(complete -- 'fff bb\b1 c')  <(echo 'ccc')
assert diff <(complete -- 'fff bbb1 c\')  <(echo 'c\cc')
assert diff <(complete -- 'fff bbb1 ccc ')  <(complete -A file)  # if word is empty and no sub-commands


## not complete option (comp word must start with valid option name)
complete -- 'fff -E'
assert $COMPREPLY.size() == 0
complete -- 'fff -E='
assert $COMPREPLY.size() == 0
complete -- 'fff --hoge'
assert $COMPREPLY.size() == 0
complete -- 'fff "--dum"'
assert $COMPREPLY.size() == 0