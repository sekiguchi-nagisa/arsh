
# complete options defined by CLI attribute

[<CLI>]
typedef CCC() {
    [<Arg>]
    var target = ""
}

var OPT: String?

function count(opt: String, prefix: String): Candidates? {
    $OPT = $opt
    var ret: Candidates
    for c in ['111', '123', '1234', '222'] {
        if $c.startsWith($prefix) {
            $ret.add($c)
        }
    }
    $prefix.startsWith('EEE') && throw new InvalidOperationError($prefix)
    return $ret
}

function output(opt: String, prefix: String): Candidates? {
    var ret: Candidates
    for c in ['AAA', 'AAB', 'ABB', 'ABC'] {
        if $c.startsWith($prefix) {
            $ret.add($c)
        }
    }
    return $ret
}

[<CLI>]
typedef BBB() {
    [<Flag(short: "v", long: "verbose")>]
    var verbose = $false

    [<Option(short: "c", long: "count", comp: $count)>]
    var count = 0

    [<Option(short: 'o', long: "output", opt:$true, comp: $output)>]
    var output : String?

    [<Option(choice: ['debug', 'info', 'warn', 'error'])>]
    var log = "warn"

    [<Option(choice: ['stdin', 'stdout', 'stderr'], opt:$true, short:'s', long:'stream')>]
    var stream = "stdin"

    [<SubCmd>]
    var ccc : CCC?
}

[<CLI>]
typedef AAA() {
    [<Option(opt: $true, short: 'd', long: 'dump')>]
    var dump : String?

    [<Flag(short: 'v', long: 'version')>]
    var version : Bool?

    [<Option(help: "")>]
    var count : Int?

    [<SubCmd(name: "bbb1")>]
    [<SubCmd(name: "bbb2")>]
    var bbb : BBB?
}

fff(p : AAA) { echo $p; }
ggg() { echo $@; }

## complete options
complete -s -- 'fff -'
assert $COMPREPLY.size() == 7
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)
assert $COMPREPLY[1] == "--dump"
assert $COMPREPLY.hasSpace(1)
assert $COMPREPLY[2] == "--help"
assert $COMPREPLY.hasSpace(2)
assert $COMPREPLY[3] == "--version"
assert $COMPREPLY.hasSpace(3)
assert $COMPREPLY[4] == "-d"
assert $COMPREPLY.hasSpace(4)
assert $COMPREPLY[5] == "-h"
assert $COMPREPLY.hasSpace(5)
assert $COMPREPLY[6] == "-v"
assert $COMPREPLY.hasSpace(6)

complete -s -- 'fff --'
assert $COMPREPLY.size() == 4
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)
assert $COMPREPLY[1] == "--dump"
assert $COMPREPLY.hasSpace(1)
assert $COMPREPLY[2] == "--help"
assert $COMPREPLY.hasSpace(2)
assert $COMPREPLY[3] == "--version"
assert $COMPREPLY.hasSpace(3)

complete -s -- 'fff --c'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)

complete -s -- 'fff --count'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--count="
assert ! $COMPREPLY.hasSpace(0)

complete -s -- 'fff --d'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--dump"
assert $COMPREPLY.hasSpace(0)

complete -s -- 'fff --dump'
assert $COMPREPLY.size() == 1
assert $COMPREPLY[0] == "--dump"
assert $COMPREPLY.hasSpace(0)

## complete file names after options
assert diff <(complete -- 'fff --count ') <(complete -A file)
assert diff <(complete -- 'fff --version ') <(complete -A file)
assert diff <(complete -- 'fff --version ./') <(complete -A file './')
assert diff <(complete -- 'fff --count=') <(complete -A file)
assert diff <(complete -- 'fff --dump=') <(complete -A file)
assert diff <(complete -- 'fff --fajjaiae ') <(complete -A file)  # complete file names after invalid option

## complete via user-defined func
assert diff <(complete -- 'fff bbb1 --count ') <(printf "%s\n" 111 123 1234 222 )
assert diff <(complete -- 'fff bbb1 --count=') <(printf "%s\n" 111 123 1234 222 )
assert diff <(complete -- 'fff bbb1 -c 12') <(printf "%s\n" 123 1234 )
assert diff <(complete -- 'fff bbb1 --count 12') <(printf "%s\n" 123 1234 )
assert diff <(complete -- 'fff bbb1 --count=2') <(printf "%s\n" 222)
assert $(complete -- 'fff bbb1 --count=3').empty()
assert diff <(complete -- 'fff bbb1 --output=') <(printf "%s\n" 'AAA' 'AAB' 'ABB' 'ABC' )
assert diff <(complete -- 'fff bbb1 --output ') <(complete -A file)
assert diff <(complete -- 'fff bbb1 -o') <(printf "%s\n" -o ) # fallback
assert diff <(complete -- 'fff bbb1 -oA') <(printf "%s\n" 'AAA' 'AAB' 'ABB' 'ABC' )
assert diff <(complete -- 'fff bbb1 -o ') <(complete -A file) # fallback

$OPT = $none
complete -- 'fff bbb1 --count '
assert $OPT! == '--count'

$OPT = $none
complete -- 'fff bbb1 --count=12'
assert $OPT! == '--count='

var ex = 2345 as Any
try { complete -- 'fff bbb1 --count=EEER'; } catch e { $ex = $e; }
assert ($ex as InvalidOperationError).message() == 'EEER'

## complete choice
assert diff <(complete -- 'fff bbb1 --log=') <(printf "%s\n" debug error info warn)
assert diff <(complete -- 'fff bbb1 --log i') <(printf "%s\n" info)
assert diff <(complete -- 'fff bbb1 -ss') <(printf "%s\n" stderr stdin stdout)
assert diff <(complete -- 'fff bbb1 -s ') <(complete -A file) # fallback
assert diff <(complete -- 'fff bbb1 --stream=stde') <(printf "%s\n" stderr)
assert diff <(complete -- 'fff bbb1 --stream ') <(complete -A file) # fallback

## complete sub-command
assert diff <(complete -- 'fff ') <(echo 'bbb1' && echo bbb2)
assert diff <(complete -- 'fff b')  <(echo 'bbb1' && echo bbb2)
assert diff <(complete -- 'fff bbb1 ')  <(echo 'ccc')
assert diff <(complete -- 'fff bbb1 c')  <(echo 'ccc')
assert diff <(complete -- 'fff bbb1 ccc ')  <(complete -A file)  # if word is empty and no sub-commands


## not complete option (comp word must start with valid option name)
complete -- 'fff -E'
assert $COMPREPLY.size() == 0
complete -- 'fff -E='
assert $COMPREPLY.size() == 0
complete -- 'fff --hoge'
assert $COMPREPLY.size() == 0
complete -- 'fff "--dum"'
assert $COMPREPLY.size() == 0