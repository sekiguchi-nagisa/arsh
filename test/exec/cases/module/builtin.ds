# for builtin command completion

# shctl
_extract_sub() {
    while(read -f $'\n') {
        var matched = $/^      ([-a-z]+) +.+/.match($REPLY)
        if let m = $matched {
            echo ${$m.group(1)!}
        }
    }
}

_extract_option() {
    for line in $STDIN {
        if let ret = $/^([a-z]+) +.+/.match($line) {
            echo ${$ret.group(1)!}
        }
    }
}

source ../../../../share/arsh/completions/builtin.arsh
source ../../../../share/arsh/completions/external.arsh

$PATH = "/usr/bin:/bin:"

assert diff <(complete 'shctl ') <(help shctl | _extract_sub | sort)
assert diff <(complete 'shctl i') <(echo info && echo is-interactive && echo is-sourced)
assert diff <(complete 'shctl \i\') <(echo '\i\nfo' && echo '\i\s-interactive' && echo '\i\s-sourced')
assert diff <(complete 'shctl set ') <(shctl set | _extract_option | sort)
assert diff <(complete 'shctl s\et \') <(shctl set | _extract_option | for line in $STDIN { echo "\\${line}"; } | sort)
assert diff <(complete 'shctl unset ') <(shctl set | _extract_option | sort)
assert diff <(complete 'shctl set assert fa') <(shctl set | _extract_option | grep fa | sort)
assert diff <(complete 'shctl set -') <(echo '-d' && echo '-r')
assert $(complete 'shctl set -d ').empty()
assert $(complete 'shctl is-interactive ').empty()
assert diff <(complete 'shctl unset c') <(echo clobber)
assert diff <(complete 'shctl module ') <(complete -Q -A module)
assert diff <(complete 'shctl module ./su') <(complete -Q -A module ./su)

# help
assert diff <(complete 'help ') <(help | cut -d ' ' -f 1)
assert diff <(complete 'help u') <(help | cut -d ' ' -f 1 | grep '^u')

# command/call/exec
assert diff <(complete 'command ') <(complete -Q -A external -A builtin "")
assert diff <(complete 'command /usr/bin/') <(complete -Q -A exec '/usr/bin/')
assert diff <(complete 'com\mand /\usr/bin/') <(complete -Q -A exec '/\usr/bin/')
assert diff <(complete 'command ~/') <(complete -Q -A exec -A tilde '~/')
assert diff <(ZZZ3=23 complete 'command unse\te\nv ZZZ') <(echo ZZZ3)
assert diff <(complete 'call ') <(complete -Q -A cmd)
assert diff <(complete 'call /usr/bin/') <(complete -Q -A exec '/usr/bin/')
assert diff <(complete 'ca\ll ~/') <(complete -Q -A exec -A tilde '~/')
assert diff <(ZZZQ3=23 complete 'call \un\set\env Z\ZZ') <(echo Z\\ZZQ3)
assert diff <(complete 'exec ') <(complete -Q -A external "")
assert diff <(complete 'ex\ec /usr/bin/') <(complete -Q -A exec "/usr/bin/")
assert diff <(complete 'exec ~/') <(complete -Q -A exec -A tilde '~/')
assert diff <(ZZZQ3=23 complete 'exec \p\rinte\nv Z\ZZ') <(echo Z\\ZZQ3)

# unsetenv
setenv 'ZZZ(3.14)=12345'

assert diff <(complete 'unsetenv ') <(complete -Q -A env)
assert diff <(complete 'unsetenv \') <(complete -Q -A env '\')
assert diff <(complete 'unsetenv H') <(complete -A env H)
assert diff <(complete 'unsetenv \H\') <(complete -A env -Q '\H\')

# cd
assert diff <(complete 'cd /') <(complete -Q -A dir '/')

# complete
assert diff <(complete -d -q -- 'complete -' && printf "%s\n" $COMPREPLY) \
            <(printf "%s\n" 
                '-A@show completion candidates via ACTION'
                '-Q@explicitly quote completion candidates'
                '-d@may put description of completion candidate'
                '-m@complete in specified module context'
                '-q@does not show completion candidates'
                '-s@may put space to completion candidate suffix'
            )

assert diff <(complete 'complete -A ') \
            <(help complete | grep -E '^      [_a-z]+' | sed 's/^      //g' | cut -d ' ' -f 1 | sort)
assert diff <(complete -d -q -- 'complete -A s' && printf "%s\n" $COMPREPLY) \
            <(printf "%s\n" 'signal@complete signal names'    'stmt_kw@complete statement keywords')
assert diff <(complete -d -q -- 'complete -Q' && printf "%s\n" $COMPREPLY) \
            <(printf "%s\n" 'arg' 'cmd')
assert diff <(complete -d -q -- 'complete -Q ' && printf "%s\n" $COMPREPLY) \
            <(complete -q -d -Q -A file && printf "%s\n" $COMPREPLY)  # fallback to filename completion

# fg/bg/jobs
var expected = new [(Job, String)]().add({
    var j = sleep 1000 &
    var f = "${$j.pid(0)!} Running  sleep 1000"
    ($j,$f)
}).add({
    var j = sleep 2000 &
    var f = "${$j.pid(0)!} Running  sleep 2000"
    ($j,$f)
}).add({
    var j = sleep 3000 &
    var f = "${$j.pid(0)!} Running  sleep 3000"
    ($j,$f)
})
defer {
    for e in $expected {
        $e._0.kill($SIGINT)
    }
}
$expected.sortBy(function(x,y)=> 
    "${x._0}".slice(1).toInt()!.compare("${y._0}".slice(1).toInt()!))

jobs -l # for debug
assert diff <(complete -d -q -- 'fg ' && printf "%s\n" $COMPREPLY) <(printf "%s@%s\n" $expected)
assert diff <(complete -d -q -- 'bg ' && printf "%s\n" $COMPREPLY) <(printf "%s@%s\n" $expected)
assert diff <(complete -d -q -- 'jobs ' && printf "%s\n" $COMPREPLY) <(printf "%s@%s\n" $expected)
assert diff <(complete -d -q -- 'jobs -l ' && printf "%s\n" $COMPREPLY) <(printf "%s@%s\n" $expected)
assert diff <(complete -d -q -- 'jobs -' && printf "%s\n" $COMPREPLY) \
            <(printf "%s\n" 
                '-l@show verbose information'
                '-p@show process id only'
                '-r@only allow running jobs'
                '-s@only allow stopped jobs'
            )