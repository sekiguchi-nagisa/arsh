
source $SCRIPT_DIR/test_helper.arsh

# \k
assert diff <(redump '\k' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Char
  token: (pos = 0, size = 2)
  codePoint: U+006B, k
EOF
)

assert diff <(redump '\k' 'u') <(<<'EOF'
1:1 [error] \k is not followed by <
 at (pos = 0, size = 2)
EOF
)

assert diff <(redump '1\k' 'v') <(<<'EOF'
1:2 [error] \k is not followed by <
 at (pos = 1, size = 2)
EOF
)

# \k<
assert diff <(redump '\k<' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Seq
  token: (pos = 0, size = 3)
  patterns:
    - kind: Char
      token: (pos = 0, size = 2)
      codePoint: U+006B, k
    - kind: Char
      token: (pos = 2, size = 1)
      codePoint: U+003C, <
EOF
)

assert diff <(redump '\k<' 'u') <(<<'EOF'
1:3 [error] capture group name must contain valid identifier: `'
 at (pos = 2, size = 1)
EOF
)

assert diff <(redump '\k<' 'v') <(<<'EOF'
1:3 [error] capture group name must contain valid identifier: `'
 at (pos = 2, size = 1)
EOF
)

# \k<2
assert diff <(redump '\k<2' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Seq
  token: (pos = 0, size = 4)
  patterns:
    - kind: Char
      token: (pos = 0, size = 2)
      codePoint: U+006B, k
    - kind: Char
      token: (pos = 2, size = 1)
      codePoint: U+003C, <
    - kind: Char
      token: (pos = 3, size = 1)
      codePoint: U+0032, 2
EOF
)

assert diff <(redump '\k<2' 'u') <(<<'EOF'
1:3 [error] capture group name must contain valid identifier: `2'
 at (pos = 2, size = 2)
EOF
)

assert diff <(redump '\k<2' 'v') <(<<'EOF'
1:3 [error] capture group name must contain valid identifier: `2'
 at (pos = 2, size = 2)
EOF
)

# \k<あ
assert diff <(redump '\k<あ' 'v') <(<<'EOF'
1:3 [error] unclosed capture group name: `あ'
 at (pos = 2, size = 4)
EOF
)

# \k<あ@
assert diff <(redump '\k<あ@' 'v') <(<<'EOF'
1:3 [error] capture group name must contain valid identifier: `あ@'
 at (pos = 2, size = 5)
EOF
)

# \k<あ1
assert diff <(redump '\k<あ1' 'v') <(<<'EOF'
1:3 [error] unclosed capture group name: `あ1'
 at (pos = 2, size = 5)
EOF
)

# \k<\
assert diff <(redump '\k<\' 'u') <(<<'EOF'
1:4 [error] invalid unicode escape: `\'
 at (pos = 3, size = 1)
EOF
)

# \k<\u
assert diff <(redump '\k<\u' 'v') <(<<'EOF'
1:4 [error] invalid unicode escape: `\u'
 at (pos = 3, size = 2)
EOF
)

# \k<\u{
assert diff <(redump '\k<\u{' 'u') <(<<'EOF'
1:4 [error] invalid unicode escape: `\u{'
 at (pos = 3, size = 3)
EOF
)

# \k<\uEEEE
assert diff <(redump '\k<\uEEEE' 'u') <(<<EOF
1:3 [error] capture group name must contain valid identifier: \`${$'\uEEEE'}'
 at (pos = 2, size = 7)
EOF
)

# \k<あ1>
assert diff <(redump '\k<あ1>' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Seq
  token: (pos = 0, size = 8)
  patterns:
    - kind: Char
      token: (pos = 0, size = 2)
      codePoint: U+006B, k
    - kind: Char
      token: (pos = 2, size = 1)
      codePoint: U+003C, <
    - kind: Char
      token: (pos = 3, size = 3)
      codePoint: U+3042, あ
    - kind: Char
      token: (pos = 6, size = 1)
      codePoint: U+0031, 1
    - kind: Char
      token: (pos = 7, size = 1)
      codePoint: U+003E, >
EOF
)

assert diff <(redump '\k<あ1>' 'u') <(<<'EOF'
1:1 [error] undefined capture group name: `あ1'
 at (pos = 0, size = 8)
EOF
)

assert diff <(redump '\k<あ1>' 'v') <(<<'EOF'
1:1 [error] undefined capture group name: `あ1'
 at (pos = 0, size = 8)
EOF
)

# \k<\u30421>
assert diff <(redump '\k<\u30421>' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Seq
  token: (pos = 0, size = 11)
  patterns:
    - kind: Char
      token: (pos = 0, size = 2)
      codePoint: U+006B, k
    - kind: Char
      token: (pos = 2, size = 1)
      codePoint: U+003C, <
    - kind: Char
      token: (pos = 3, size = 6)
      codePoint: U+3042, あ
    - kind: Char
      token: (pos = 9, size = 1)
      codePoint: U+0031, 1
    - kind: Char
      token: (pos = 10, size = 1)
      codePoint: U+003E, >
EOF
)

assert diff <(redump '\k<\u30421>' 'u') <(<<'EOF'
1:1 [error] undefined capture group name: `あ1'
 at (pos = 0, size = 11)
EOF
)

assert diff <(redump '\k<\u30421>' 'v') <(<<'EOF'
1:1 [error] undefined capture group name: `あ1'
 at (pos = 0, size = 11)
EOF
)

assert diff <(redump '\k<\u{3042}1>' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: Seq
  token: (pos = 0, size = 13)
  patterns:
    - kind: Char
      token: (pos = 0, size = 2)
      codePoint: U+006B, k
    - kind: Char
      token: (pos = 2, size = 1)
      codePoint: U+003C, <
    - kind: Repeat
      token: (pos = 3, size = 8)
      repeat: (min = 3042, max = 3042)
      greedy: true
      pattern:
        kind: Char
        token: (pos = 3, size = 2)
        codePoint: U+0075, u
    - kind: Char
      token: (pos = 11, size = 1)
      codePoint: U+0031, 1
    - kind: Char
      token: (pos = 12, size = 1)
      codePoint: U+003E, >
EOF
)

assert diff <(redump '\k<\u{3042}1>' 'v') <(<<'EOF'
1:1 [error] undefined capture group name: `あ1'
 at (pos = 0, size = 13)
EOF
)