
source $SCRIPT_DIR/test_helper.arsh

# [\q]
assert diff <(redump '[\q]' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 4)
  class: UNION
  invert: false
  chars:
    - kind: Char
      token: (pos = 1, size = 2)
      codePoint: U+0071, q
EOF
)

assert diff <(redump '[\q]' 'u') <(<<'EOF'
1:2 [error] invalid escape: `\q'
 at (pos = 1, size = 2)
EOF
)

assert diff <(redump '[\q]' 'v') <(<<'EOF'
1:2 [error] invalid escape: `\q'
 at (pos = 1, size = 2)
EOF
)

# [\q{]
assert diff <(redump '[\q{]' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 5)
  class: UNION
  invert: false
  chars:
    - kind: Char
      token: (pos = 1, size = 2)
      codePoint: U+0071, q
    - kind: Char
      token: (pos = 3, size = 1)
      codePoint: U+007B, {
EOF
)

assert diff <(redump '[\q{]' 'u') <(<<'EOF'
1:2 [error] invalid escape: `\q'
 at (pos = 1, size = 2)
EOF
)

assert diff <(redump '[\q{]' 'v') <(<<'EOF'
1:5 [error] invalid character in character class: `]'
 at (pos = 4, size = 1)
EOF
)

# [\q{
assert diff <(redump '[\q{' '') <(<<'EOF'
1:1 [error] unclosed character class
 at (pos = 0, size = 4)
EOF
)

assert diff <(redump '[\q{' 'u') <(<<'EOF'
1:2 [error] invalid escape: `\q'
 at (pos = 1, size = 2)
EOF
)

assert diff <(redump '[\q{' 'v') <(<<'EOF'
1:2 [error] unclosed substring
 at (pos = 1, size = 3)
EOF
)

# [\q{}]
assert diff <(redump '[\q{}]' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 6)
  class: UNION
  invert: false
  chars:
    - kind: Char
      token: (pos = 1, size = 2)
      codePoint: U+0071, q
    - kind: Char
      token: (pos = 3, size = 1)
      codePoint: U+007B, {
    - kind: Char
      token: (pos = 4, size = 1)
      codePoint: U+007D, }
EOF
)

assert diff <(redump '[\q{}]' 'u') <(<<'EOF'
1:2 [error] invalid escape: `\q'
 at (pos = 1, size = 2)
EOF
)

assert diff <(redump '[\q{}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 6)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 4)
      patterns:
        - kind: Empty
          token: (pos = 4, size = 0)
EOF
)

# [\q{1}]
assert diff <(redump '[\q{1}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 7)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 5)
      patterns:
        - kind: Char
          token: (pos = 4, size = 1)
          codePoint: U+0031, 1
EOF
)

# [\q{\b}]
assert diff <(redump '[\q{\b}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 8)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 6)
      patterns:
        - kind: Char
          token: (pos = 4, size = 2)
          codePoint: U+0008, \x08
EOF
)

# [\q{\B}]
assert diff <(redump '[\q{\B}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\B'
 at (pos = 4, size = 2)
EOF
)

# [\q{\w}]
assert diff <(redump '[\q{\w}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\w'
 at (pos = 4, size = 2)
EOF
)

# [\q{\W}]
assert diff <(redump '[\q{\W}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\W'
 at (pos = 4, size = 2)
EOF
)

# [\q{\d}]
assert diff <(redump '[\q{\d}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\d'
 at (pos = 4, size = 2)
EOF
)

# [\q{\D}]
assert diff <(redump '[\q{\D}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\D'
 at (pos = 4, size = 2)
EOF
)

# [\q{\s}]
assert diff <(redump '[\q{\s}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\s'
 at (pos = 4, size = 2)
EOF
)

# [\q{\S}]
assert diff <(redump '[\q{\S}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\S'
 at (pos = 4, size = 2)
EOF
)

# [\q{\p{C}}]
assert diff <(redump '[\q{\p{C}}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\p'
 at (pos = 4, size = 2)
EOF
)


# [\q{\P{C}}]
assert diff <(redump '[\q{\P{C}}]' 'v') <(<<'EOF'
1:5 [error] invalid escape: `\P'
 at (pos = 4, size = 2)
EOF
)

# [\q{|}]
assert diff <(redump '[\q{|}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 7)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 5)
      patterns:
        - kind: Empty
          token: (pos = 4, size = 0)
        - kind: Empty
          token: (pos = 5, size = 0)
EOF
)

# [\q{a|}]
assert diff <(redump '[\q{a|}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 8)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 6)
      patterns:
        - kind: Char
          token: (pos = 4, size = 1)
          codePoint: U+0061, a
        - kind: Empty
          token: (pos = 6, size = 0)
EOF
)

# [\q{a|}]
assert diff <(redump '[\q{|\n}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 9)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 7)
      patterns:
        - kind: Empty
          token: (pos = 4, size = 0)
        - kind: Char
          token: (pos = 5, size = 2)
          codePoint: U+000A, \x0A
EOF
)

# [\q{ab|\u7058\u{24155}}]
assert diff <(redump '[\q{ab|\u7058\u{24155}}]' 'v') <(<<'EOF'
flag: (mode = v, modifier = )
captureGroupCount: 0
namedCaptureGroups: []
pattern:
  kind: CharClass
  token: (pos = 0, size = 24)
  class: UNION
  invert: false
  chars:
    - kind: Alt
      token: (pos = 1, size = 22)
      patterns:
        - kind: Seq
          token: (pos = 4, size = 2)
          patterns:
            - kind: Char
              token: (pos = 4, size = 1)
              codePoint: U+0061, a
            - kind: Char
              token: (pos = 5, size = 1)
              codePoint: U+0062, b
        - kind: Seq
          token: (pos = 7, size = 15)
          patterns:
            - kind: Char
              token: (pos = 7, size = 6)
              codePoint: U+7058, 灘
            - kind: Char
              token: (pos = 13, size = 9)
              codePoint: U+24155, 𤅕
EOF
)