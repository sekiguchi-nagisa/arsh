
source $SCRIPT_DIR/test_helper.arsh

# (?<a
assert diff <(redump '(?<a' '') <(<<'EOF'
1:3 [error] unclosed capture group name: `a'
 at (pos = 2, size = 2)
EOF
)

# (?<a>
assert diff <(redump '(?<a>' '') <(<<'EOF'
1:6 [error] unclosed group
 at (pos = 5, size = 0)
EOF
)

# (?<a1>)
assert diff <(redump '(?<a1>)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 1
namedCaptureGroups: [a1: 1]
pattern:
  kind: Group
  token: (pos = 0, size = 7)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Empty
    token: (pos = 6, size = 0)
EOF
)

# (?<a1>|)
assert diff <(redump '(?<a1>|)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 1
namedCaptureGroups: [a1: 1]
pattern:
  kind: Group
  token: (pos = 0, size = 8)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Alt
    token: (pos = 6, size = 1)
    patterns:
      - kind: Empty
        token: (pos = 6, size = 0)
      - kind: Empty
        token: (pos = 7, size = 0)
EOF
)

# (?<a1>|)
assert diff <(redump '(?<a1>a|)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 1
namedCaptureGroups: [a1: 1]
pattern:
  kind: Group
  token: (pos = 0, size = 9)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Alt
    token: (pos = 6, size = 2)
    patterns:
      - kind: Char
        token: (pos = 6, size = 1)
        codePoint: U+0061, a
      - kind: Empty
        token: (pos = 8, size = 0)
EOF
)

# (?<a1>|)
assert diff <(redump '(?<a1>|v)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 1
namedCaptureGroups: [a1: 1]
pattern:
  kind: Group
  token: (pos = 0, size = 9)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Alt
    token: (pos = 6, size = 2)
    patterns:
      - kind: Empty
        token: (pos = 6, size = 0)
      - kind: Char
        token: (pos = 7, size = 1)
        codePoint: U+0076, v
EOF
)

# (?<あい>.)
assert diff <(redump '(?<あい>.)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 1
namedCaptureGroups: [あい: 1]
pattern:
  kind: Group
  token: (pos = 0, size = 12)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Any
    token: (pos = 10, size = 1)
EOF
)

# (?<あい>(?<うえ>))
assert diff <(redump '(?<あい>(?<うえ>{))' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 2
namedCaptureGroups: [あい: 1, うえ: 2]
pattern:
  kind: Group
  token: (pos = 0, size = 23)
  group: CAPTURE
  index: 1
  setModifiers:
  unsetModifiers:
  pattern:
    kind: Group
    token: (pos = 10, size = 12)
    group: CAPTURE
    index: 2
    setModifiers:
    unsetModifiers:
    pattern:
      kind: Char
      token: (pos = 20, size = 1)
      codePoint: U+007B, {
EOF
)

assert diff <(redump '(?<あい>(?<うえ>{))' 'u') <(<<'EOF'
1:21 [error] lone quantifier bracket `{'
 at (pos = 20, size = 1)
EOF
)

# (?<aa>)(?<aa>)
assert diff <(redump '(?<aa>)(?<aa>)' '') <(<<'EOF'
1:8 [error] duplicated capture group name: `aa'
 at (pos = 7, size = 6)
EOF
)

assert diff <(redump '(?<aa>)(?<aa>)' 'u') <(<<'EOF'
1:8 [error] duplicated capture group name: `aa'
 at (pos = 7, size = 6)
EOF
)

# (?<aa>|((?<aa>w)))
assert diff <(redump '(?<aa>|((?<aa>w)))' '') <(<<'EOF'
1:9 [error] duplicated capture group name: `aa'
 at (pos = 8, size = 6)
EOF
)

assert diff <(redump '(?<aa>|((?<aa>w)))' 'v') <(<<'EOF'
1:9 [error] duplicated capture group name: `aa'
 at (pos = 8, size = 6)
EOF
)

# (?<aa>a)|(?<aa>b)
assert diff <(redump '(?<aa>a)|(?<aa>b)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 2
namedCaptureGroups: [aa: [1, 2]]
pattern:
  kind: Alt
  token: (pos = 0, size = 17)
  patterns:
    - kind: Group
      token: (pos = 0, size = 8)
      group: CAPTURE
      index: 1
      setModifiers:
      unsetModifiers:
      pattern:
        kind: Char
        token: (pos = 6, size = 1)
        codePoint: U+0061, a
    - kind: Group
      token: (pos = 9, size = 8)
      group: CAPTURE
      index: 2
      setModifiers:
      unsetModifiers:
      pattern:
        kind: Char
        token: (pos = 15, size = 1)
        codePoint: U+0062, b
EOF
)

# (?<aa>a(?<bb>e))|(?<aa>b)
assert diff <(redump '(?<aa>a(?<bb>e))|(?<aa>b)' '') <(<<'EOF'
flag: (mode = , modifier = )
captureGroupCount: 3
namedCaptureGroups: [aa: [1, 3], bb: 2]
pattern:
  kind: Alt
  token: (pos = 0, size = 25)
  patterns:
    - kind: Group
      token: (pos = 0, size = 16)
      group: CAPTURE
      index: 1
      setModifiers:
      unsetModifiers:
      pattern:
        kind: Seq
        token: (pos = 6, size = 9)
        patterns:
          - kind: Char
            token: (pos = 6, size = 1)
            codePoint: U+0061, a
          - kind: Group
            token: (pos = 7, size = 8)
            group: CAPTURE
            index: 2
            setModifiers:
            unsetModifiers:
            pattern:
              kind: Char
              token: (pos = 13, size = 1)
              codePoint: U+0065, e
    - kind: Group
      token: (pos = 17, size = 8)
      group: CAPTURE
      index: 3
      setModifiers:
      unsetModifiers:
      pattern:
        kind: Char
        token: (pos = 23, size = 1)
        codePoint: U+0062, b
EOF
)

# (((?<aa>a)|(?<aa>b))|)(?<aa>.)
assert diff <(redump '(((?<aa>a)|(?<aa>b))|)(?<aa>.)' '') <(<<'EOF'
1:23 [error] duplicated capture group name: `aa'
 at (pos = 22, size = 6)
EOF
)