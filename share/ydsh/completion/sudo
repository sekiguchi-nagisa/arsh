#!/usr/bin/env ydsh

source $SCRIPT_DIR/../module/completion

function _sudo($ctx : Module, $t : [String], $c : Int) : [String]? {
    for(var i = 1; $i < $t.size(); $i++) {
        var v = $t[$i]
        case $v {
        $/^-.*$/ => continue
        else => if $i < $t.size() - 1 || $c == $t.size() {
                    return {
                        importenv PATH : ""
                        PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin $compDelegate($ctx, $t.slice($i), $c - $i)
                    }
                }
        }
    }
    if $c < $t.size() && $t.peek() == '-' {
        return ['-A', '-b', '-E', '-H', '-n', '-P', '-S']
    }
    importenv PATH : ""
    PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin complete -q -A external ${$c < $t.size() ? $t.peek() : ""}
    return $COMPREPLY
}

$compAdd("sudo", $_sudo)